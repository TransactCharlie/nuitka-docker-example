language: c++
sudo: required
services:
    - docker

before_install:
    - sudo apt-get update -qq
    - sudo apt-get install -qq python3-dev python python3-pip chrpath

install:
    - pip3 install -r app/requirements.txt

script:
    # Compile app
    - nuitka --portable --show-progress --show-scons --remove-output --improved --python-flag=no_site app/app.py

    # Copy dependent linked libs
    - chmod +x build_scripts/ldd_cp.sh
    - build_scripts/ldd_cp.sh "app.dist/app.exe" "app.dist"

    # What did we end up with??
    - ls -lhR app.dist

    # Docker Build
    - cp Dockerfile app.dist
    - docker build -t ${REPO} app.build

    # Run it
    - docker run ${REPO}


#- docker build -t $REPO:$COMMIT .

# after_success:
# - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH; fi`
# - docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
# - docker tag $REPO:$COMMIT $REPO:$TAG
# - docker tag $REPO:$COMMIT $REPO:travis-$TRAVIS_BUILD_NUMBER
# - docker push $REPO
# - curl -X POST https://hooks.microbadger.com/images/skyscanner/scollector/JrlH6udCH0uKSpdNrYjfuNlmH3Y=

env:
  global:
  - COMMIT=${TRAVIS_COMMIT::8}
  - REPO=transactcharlie/nuitka-docker-example
